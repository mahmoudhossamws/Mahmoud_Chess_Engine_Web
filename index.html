<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robust Chess Game - Dark Theme</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Local styles (corrected filename) -->
    <link rel="stylesheet" href="style.css">
    <link rel="preload" as="image" href="images/mahmoud.jpg" imagesrcset="images/mahmoud.jpg 128w, images/mahmoud.jpg 256w" imagesizes="(max-width: 800px) 100px, 128px" fetchpriority="high">
</head>
<body>
    <div class="container">
        <div id="leftPlayerPanel" class="player-panel">
            <div class="player-info active">
                <img 
                  src="images/yourphoto.jpg"
                  srcset="images/yourphoto.jpg 1x, images/yourphoto.jpg 2x"
                  sizes="128px"
                  width="128" height="128"
                  alt="Your Photo"
                  loading="lazy"
                  decoding="async">
                <h3>You</h3>
                <p>(White)</p>
            </div>
            <div class="winning-probability">
                <h4>Winning Probability (White)</h4>
                <p id="whiteProbability">Waiting for moves...</p>
            </div>
        </div>

        <div class="middle-section">
            <div id="board"></div>
            <div class="game-status" id="gameStatus">Initializing game...</div>
            <div class="game-info-text">
                <p><strong>Who is winning:</strong> <span id="whoIsWinning">Loading...</span></p>
            </div>
            <div class="game-controls">
                <button id="startNewGameBtn">Start New Game</button>
            </div>
        </div>

        <div id="rightPlayerPanel" class="player-panel right">
                        <div class="player-info">
                                <img 
                                    src="images/mahmoud.jpg"
                                    srcset="images/mahmoud.jpg 128w, images/mahmoud.jpg 256w"
                                    sizes="(max-width: 800px) 100px, 128px"
                                    width="128" height="128"
                                    alt="Mahmoud's Photo" 
                                    loading="eager"
                                    fetchpriority="high"
                                    decoding="async">
                <h3>Mahmoud</h3>
                <p>(Black)</p>
            </div>
            <div class="winning-probability">
                <h4>Winning Probability (Black)</h4>
                <p id="blackProbability">Waiting for moves...</p>
            </div>
        </div>
    </div>

    <!-- Promotion Modal -->
    <div id="promotionModal" class="promotion-modal">
        <div class="promotion-content">
            <h3>Promote pawn to:</h3>
            <div class="promotion-options">
                <button data-piece="q">Queen</button>
                <button data-piece="r">Rook</button>
                <button data-piece="b">Bishop</button>
                <button data-piece="n">Knight</button>
            </div>
        </div>
    </div>

                <!-- Load chess.js (rules engine). If this fails, the page will alert. -->
                <script src="https://unpkg.com/chess.js@0.10.3/chess.js"></script>
                <!-- Optional: connect to the engine Space via Gradio JS client; fails gracefully if offline/unavailable -->
                        <script type="module">
                            import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client@latest/+esm";
                            let gradioClient = null;
                            try {
                                gradioClient = await Client.connect("mahmoudhossamws/Mahmoud_Chess_Engine");
                            } catch (e) {
                                // silently continue; UI will use placeholders
                            }
                            async function fetchEngineEval(fen) {
                                if (!gradioClient) throw new Error('Engine client not available');
                                // Your API: Interface with Textbox input returns [best_move, probability]
                                const res = await gradioClient.predict("/predict", [fen]);
                                // Normalize response
                                let data = (res && res.data) ? res.data : res;
                                if (!Array.isArray(data) || data.length < 2) {
                                    throw new Error('Unexpected engine response shape');
                                }
                                const best_move = String(data[0] ?? '').trim();
                                let prob = parseFloat(data[1]);
                                if (!Number.isFinite(prob)) throw new Error('Invalid probability value');
                                // Ensure 0..1 range
                                if (prob > 1 && prob <= 100) prob = prob / 100;
                                prob = Math.min(1, Math.max(0, prob));
                                return { best_move, prob };
                            }
                            window.fetchEngineEval = fetchEngineEval;
                            // Notify the app that the engine client setup has finished (success or failure)
                            window.dispatchEvent(new CustomEvent('engineClientReady', { detail: { ok: !!gradioClient } }));
                        </script>
        <script src="script.js"></script>
</body>
</html>